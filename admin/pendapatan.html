<!--#include file="all-head.html"-->

<div class="row">
  <div class="col-sm-3">
    <div class="card">
      <div class="card-body">
        <form id="submitFormPendapatan" method="post" novalidate="novalidate">
          <div class="form-group">
            <label for="jenis_pendapatan_id" class="control-label mb-1">Jenis Pendapatan</label>
            <select id="jenis_pendapatan_id" class="form-control"></select>
          </div>
          <div class="form-group">
            <label for="sumber_pendapatan_id" class="control-label mb-1">Sumber Pendapatan</label>
            <select id="sumber_pendapatan_id" class="form-control"></select>
          </div>
          <div class="form-group">
            <label class="control-label mb-1">Nominal</label>
            <input id="nominal" name="var1" type="text" class="currency form-control" aria-required="true" aria-invalid="false" value="0">
          </div>
          <small class="text-center text-danger">Jika tidak ada variabel pengali biarkan nilai tetap <b>1</b></small>
          <br>
          <div class="form-group">
            <label class="control-label mb-1">Jumlah Siswa</label>
            <select id="jumlah_siswa_id" class="form-control" name="jumlah_siswa"></select>
          </div>
          <div class="row">
            <div class="col-4">
              <label class="control-label mb-1">Var 1</label>
              <div class="form-group">
                <input id="var1" name="var1" type="number" class="form-control" aria-required="true" aria-invalid="false" value="1">
              </div>
            </div>
            <div class="col-4">
              <label class="control-label mb-1">Var 2</label>
              <div class="form-group">
                <input id="var2" name="var2" type="number" class="form-control" aria-required="true" aria-invalid="false" value="1">
              </div>
            </div>
            <div class="col-4">
              <label class="control-label mb-1">Var 3</label>
              <div class="form-group">
                <input id="var3" name="var3" type="number" class="form-control" aria-required="true" aria-invalid="false" value="1">
              </div>
            </div>
          </div>
          <label class="control-label mb-1">
            <small class="text-muted">
              var1, var2, var3 diganti ketika ingin mengalikan dengan bulan, atau nilai tertentu
            </small>
          </label>
          <div>
            <button id="payment-button" type="submit" class="btn btn-lg btn-info btn-block">
              <i class="fa fa-save fa-lg"></i>&nbsp;
              <span id="payment-button-amount">SIMPAN</span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="col-sm-9">
    <div class="col">
      <div class="table-responsive-lg">
        <table class="datatables table table-sm table-hover table-bordered table-striped">
          <legend>
            <small>Jumlah = Nominal * Jumlah Siswa * Var 1 * Var 2 * Var 3</small>
          </legend>
          <hr>
          <thead>
            <tr>
              <th>No</th>
              <th>Sumber</th>
              <th>Jenis Sumber</th>
              <th>Nominal</th>
              <th>Jumlah</th>
              <th>Tgl</th>
              <th>Tindakan</th>
            </tr>
          </thead>
          <tbody id="dataPendapatan"></tbody>
        </table>
      </div>
    </div>
    <div class="col">
      <h3 id="totalPendapatan"></h3>
    </div>
  </div>
</div>

<script>
  //tampilkan data untuk dropdown
  $(document).ready(() => {
    //load modal edit pendapatan
    $('#appendModalHere').load('modals/modal-edit-pendapatan.html');
    //append select option jumlah siswa
    var Html = '';
    API_REQUEST('all/jenis-pendapatan', 'GET', token, '', '').done((res) => {
      $.each(res, (index, el) => {
        Html += `<option value="${ el.id_jenis_pendapatan }">${ el.jenis_pendapatan }</option>`;
      });
      $('#jenis_pendapatan_id').html("<option>Jenis Sumber</option>" + Html);
    });
    //aktifkan pilihan setelah user mengganti select option
    $('#jenis_pendapatan_id').change(function(e){
      var id = $('#jenis_pendapatan_id option:selected').val();
      API_REQUEST('all/sumber-pendapatan/by/jenis/', 'GET', token, id, '').done(function(r){
        var forOption = '';
        var no = 1;
        $.each(r, function(k, v) {
          forOption += `<option value="${ v.id_sumber_pendapatan }">${ v.sumber_pendapatan }</option>`;
        });
        $('#sumber_pendapatan_id').html('<option>Pilih Sumber</option>' + forOption);
      });
    });
    /*append select option jumlah siswa*/
    var jsHtml = '';
    API_REQUEST('all/jumlah-siswa', 'GET', token, '', '').done((res) => {
      $.each(res, (index, el) => {
        jsHtml += `<option value="${ el.id_jm_siswa }-${ el.jumlah_siswa }">TA. ${ el.tahun_ajaran }, Siswa : ${  el.jumlah_siswa } Org</option>`;
      });
      $('#jumlah_siswa_id').html("<option value='0-1'>Jumlah Siswa : 1</option>" + jsHtml);
    });
  });
  //show all pendapatan
  function AllPendapatan() {
    API_REQUEST('all/pendapatan', 'GET', token, '', '').done(function(res){
      var html = '';
      var no = 1;
      var total = 0;
      $.each(res, (index, el) => {
        var splitTgl = el.create_at.split("T");
        html += `<tr>
          <td>${ no++ }</td>
          <td>${ el.JenisPendapatan.jenis_pendapatan }</td>
          <td>${ el.Sumber.SumberPendapatan.sumber_pendapatan }</td>
          <td class="text-right">${ formatNum(el.Sumber.nominal_angsuran) }</td>
          <td class="text-right">${ formatNum(el.Sumber.jumlah) }</td>
          <td>${ splitTgl[0] }</td>
          <td>
            <button class="btn btn-sm btn-warning text-white" id="updatePendapatan" data-id="${ el.id_pendapatan }" data-toggle="modal" data-target="#modalEditPendapatan"><i class="fa fa-edit"></i></button>
            <button class="btn btn-sm btn-danger" id="deletePendapatan" data-id="${ el.id_pendapatan }"><i class="fa fa-trash"></i></button>
          </td>
        </tr>`;
        total += el.Sumber.jumlah;
      });
      $('#totalPendapatan').html(`<div class="card bg-success"><div class="card-body"> TOTAL PENDAPATAN : <div class="float-right">Rp `+formatNum(total)+`</div></div></div>`);
      $('#dataPendapatan').html(html);
    });
  }
  //semua sumber pendapatan
  AllPendapatan();
  //simpan pendapatan
  $(document).on('submit', '#submitFormPendapatan', function(event) {
    event.preventDefault();
    var siswa = $('#jumlah_siswa_id option:selected').val();
    var dataSplit = siswa.split("-");
    var data = JSON.stringify({
      id_pendapatan:'',
      jenis_pendapatan_id : parseInt($('#jenis_pendapatan_id option:selected').val()),
      user_id : parseInt(GenerateToken().id_user),
      Sumber : {
        id_sumber:'',
        pendapatan_id:'',
        nominal_angsuran : removeCommaSeparator('#nominal'),
        jumlah_siswa_id : parseInt(dataSplit[0]),
        sumber_pendapatan_id : parseInt($('#sumber_pendapatan_id option:selected').val()),
        var1 : parseInt($('#var1').val()),
        var2 : parseInt($('#var2').val()),
        var3 : parseInt($('#var3').val()),
        jumlah : removeCommaSeparator('#nominal') * dataSplit[1] * parseInt($('#var1').val()) * parseInt($('#var2').val()) * parseInt($('#var3').val())
      }
    });
    API_REQUEST('add/pendapatan', 'POST', token, '', data).done(function(e){
      Swal.fire({
        icon: 'success',
        title: 'Ok',
        text: 'Created'
      }, AllPendapatan());
    });
  });
  //hapus pendapatan
  $(document).on('click', '#deletePendapatan', function(e) {
    e.preventDefault();
    var id = $(this).data('id');
    Swal.fire({
      title:'Apakah anda yakin menghapus data ini?',
      text:'',
      icon:'warning',
      showCancelButton: true,
      confirmButtonColor: '#3085d6',
      cancelButtonColor: '#d33',
      confirmButtonText: 'Yes, delete it!',
      closeOnConfirm: false
    }).then((result) => {
      if (result.value == true) {
        API_REQUEST('delete/pendapatan/', 'DELETE', token, id, '').done(function(event) {
          Swal.fire({
            icon:'success',
            title:'Ok',
            text:'Deleted'
          }, AllPendapatan());
        });
      } else { 
        result.dismiss; 
      }
    });
  });
  //submit edit data pendapatan
  $(document).on('submit', '#submitEditPendapatan', function(e) {
    e.preventDefault();
    var siswa = $('#jumlah_siswa_id_e option:selected').val();
    var dataSplit = siswa.split("-");
    var data = JSON.stringify({
      id_pendapatan : parseInt($('#id_pendapatan_e').val()),
      jenis_pendapatan_id : parseInt($('#jenis_pendapatan_id_e option:selected').val()),
      user_id : parseInt(GenerateToken().IDUser),
      Sumber : {
        pendapatan_id : parseInt($('#id_pendapatan_e').val()),
        nominal_angsuran : removeCommaSeparator('#nominal_e'),
        jumlah_siswa_id : parseInt(dataSplit[0]),
        sumber_pendapatan_id : parseInt($('#sumber_pendapatan_id_e option:selected').val()),
        var1 : parseInt($('#var1_e').val()),
        var2 : parseInt($('#var2_e').val()),
        var3 : parseInt($('#var3_e').val()),
        jumlah : removeCommaSeparator('#nominal_e') * dataSplit[1] * parseInt($('#var1_e').val()) * parseInt($('#var2_e').val()) * parseInt($('#var3_e').val())
      }
    });
    API_REQUEST('update/pendapatan', 'PUT', token, '', data).done(function(){
      Swal.fire({
        icon: 'success',
        title: 'Ok',
        text: 'Created'
      }, AllPendapatan());
    });
  });
</script>

<!--#include file="all-foot.html"-->